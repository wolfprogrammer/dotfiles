%	Projeto de conversor BUCK para painel solar
%  modelo MX60  / marca SOLAREX
%

%--------------------------------------
% 	PAINEL SOLAR / PV ARRAY
%
Pm=   60   % W
Vmp=  17.1 % V
Imp=   3.5 % A
Isc=   3.8 % A
Voc=  21.1 % V

av=-80*1e-3 % V/ºC
ai= 0.065   % %/ºC
ap=-0.5	    % %/ºC
NOCT= 47  % ºC

%--------------------------------------
% 	Battery: Lead Acid Battery
%	Bateria de chumbo ácido
Vbat=12 % Volts


%--------------------------------------
%%%%%%%   Caculations  %%%%%%%%%%%%%%%%
%--------------------------------------	
printf("\n\nCalculations:\n:");

%
% Definições de projeto
fs=200e3     % [Hz] Frequência de chaveamento 
ri=0.30     % Current ripple Oscilação de corrente 10% do valor de entrada
rv=0.01     % Voltage ripple Oscilação de tensão de saída    

Ts=1/fs

Pmax=Pm	% Máxima potência do painel solar a 25ºC
Pmin=0.01*Pmax

Vo=Vbat % Tensão de saída do conversor buck

Vin1= 1.20*Vo   % Mínima tensão de entrada 
Vin2= Vmp   % Máxima tensão de entrada

Iin1=msx60i(Vin1,1,25)
Iin2=msx60i(Vin2,1,25)




Pin1=Iin1*Vin1
Pin2=Iin2*Vin2

%-------------------------------------%
printf("\n\nConsiderando potência constante\n")
P=Pm
D1=Vo/Vin1
D2=Vo/Vin2
Io1=Pm/Vo
Io2=Pm/Vo
Id1=Pm/Vin1
Id2=Pm/Vin2



[L1 C1]=lcbuck(Vin1,Vo,Pmax,fs,ri,rv)
[L2 C2]=lcbuck(Vin2,Vo,Pmax,fs,ri,rv)
Lmin1=max(L1,L2)
Cmin1=max(C1,C2)
%--------------------------------------%

printf("\n\nConsiderando a potência variante\n\n");


[L1 C1]=lcbuck(Vin1,Vo,Pin1,fs,ri,rv)
[L2 C2]=lcbuck(Vin2,Vo,Pin2,fs,ri,rv)
Lmin2=max(L1,L2)
Cmin2=max(C1,C2)
 

%=========  TESTES ===================%

N=100;
v=linspace(0,Voc,100);
i=msx60i(v,1,25);           % Corrente do módulo solar msx60 v volts em STC
P=i.*v;
L=Lmin1;
C=Cmin1;
D=Vo./v ;	            % Vetor do duty-cycle
f=fs;
T=1/fs;

Vo=D.*v;
Io=P./Vo;
Iob=Vo.*(1-D)/(2*f*L);      %  (MOHAN,1995,p169)
 
idx1=Io>Iob

idx2=Io<Iob


d1=zeros(1,N);
d1(idx2)=2*L*i(idx2)./(v(idx2).*D(idx2)*Ts)-D(idx2) ; % 
Vo(idx2)=(d1(idx2)+D(idx2))./d1(idx2).*v(idx2);
Io=d1/(d1+D)*Id; 




from robotlib import *
from string import atoi, atof

INP=0

if INP==1:
	ARM=raw_input("Entre com ARM=+1 Braco direito ; ARM=-1 Braco esquerdo\nARM=")
	ELBOW=raw_input("Entre com ELBOW=+1 Braco acima ; ELBOW=-1 Braco abaixo\nELBOW=")
	WRIST=raw_input("Entre com WRIST=+1 Punho abaixado ; WRIST=-1 Punho Levantado\nWRIST=")  
	FLIP=raw_input("Entre com FLIP=0 Sem FLIP ; FLIP =1 Com FLIP\nFLIP=")

	ARM=atoi(ARM)
	ELBOW=atoi(ELBOW)
	WRIST=atoi(WRIST)
	FLIP=atoi(FLIP)

if INP==0:
	ARM=-1
	ELBOW=+1
	WRIST=-1
	FLIP=0


d2=149.09
d4=433.07
d6=56.25

a2=431.8
a3=-20.32

Ht=[ [ 0 , -1 , 0 , -149.09 ],  [ 0 ,  0 , 1 , 902.5], [-1 ,  0 , 0 ,    0 ], [ 0 ,  0 , 0 ,    1]]

Ht=matrix(Ht)


[n,s,a,p]= nsap(Ht)

pc=p-a*d6

[px,py,pz]=xyz(pc)



#  Teta 1

R=sqrt(px**2+py**2)
R1=R
r=sqrt(R**2-d2**2)

phi=atan2(py,px)   ; phi1=phi
alpha=atan2(d2,r)  ; alpha1=alpha

if ARM==-1:
	q1=phi-alpha  
if ARM==1:
	q1=phi+alpha+180






# Teta2
K=ARM*ELBOW

R=sqrt(r**2+pz**2) ; R2=R
alpha=atan2(-pz,-ARM*r)

X=sqrt(d4**2+a3**2)
Cb=(a2**2+R**2-X**2)/(2*a2*R)
Sb=sqrt(1-Cb**2)
beta=atan2(Sb,Cb)  ; beta2=beta

q2=alpha+K*beta


# Teta 3 
#
X=sqrt(d4**2+a3**2)
R=R2
Cphi=(a2**2+X**2-R**2)/(2*a2*X)
Sphi=K*sqrt(1-Cphi**2)
phi=atan2(Sphi,Cphi)
beta=atan2(d4,abs(a3))  ;  beta3=beta
q3=phi-beta

     # theta  alpha a  d 
tab3=[[ q1 , -90.0 , 0 ,  0 ],  [ q2 ,  00 , d2, a2 ],  [ q3 ,  90.0 , 0 , a3 ]] 

[H3,H03]=DHH(tab3,0)
[X3,Y3,Z3,P3]=nsap(H03)



# Teta 4
#
Z4=norm(Z3,a)

omega=dotp(s,Z4)

M=WRIST*sign(omega)

S4=-M*dotp(Z4,X3)
C4= M*dotp(Z4,Y3)
q4=atan2(S4,C4)

H34=DH(q4,-90,d4,0)
H04=H03*H34
[X4,Y4,Z4,P4]=nsap(H04)

# Teta 5
#

S5= dotp(a,X4)
C5=-dotp(a,Y4)
q5=atan2(S5,C5)

H45=DH(q5,90,0,0)
H05=H04*H45
[X5,Y5,Z5,P5]=nsap(H05)

# Teta 6
S6= dotp(n,Y5)
C6=-dotp(s,Y5)
q6=atan2(S6,C6)


if FLIP==1:
	q4=q4+180
	q5=-q5
	q6=q6+180

###########################
#    Teste da resposta    #
###########################

R03=H03[0:3,0:3]
R06=Ht[0:3,0:3]
R36=R03.transpose()*R06

r11=R36[0,0]
r12=R36[0,1]
r13=R36[0,2]

r21=R36[1,0]
r22=R36[1,1]
r23=R36[1,2]
 
r31=R36[2,0]
r32=R36[2,1]
r33=R36[2,2]

c1=cosd(q1)
s1=sind(q1)
c23=cosd(q2+q3)
s23=sind(q2+q3)

qq4=atan2(c1*c23*r13 + s1*c23*r23 + s23*r33 , -c1*s23*r13 - s1*s23*r23 + c23*r33)
c5=s1*r13 - c1*r23
s5=sqrt(1-c5**2)
qq5=atan2(s5,c5)
qq6=atan2(-s1*r11 + c1*r21, s1*r12 - c1*r22)



#q4=qq4
#q5=qq5
#q6=qq6


tabdh= [ \
       [q1,  -90.00 ,   0   ,     0.0  ], \
       [q2,   00.00 , 149.09,   431.8  ], \
       [q3,   90.00 ,   0.00,   -20.32 ], \
       [q4,  -90.00 , 433.07,     0.0  ], \
       [q5,   90.00 ,   0.00,     0.0  ], \
       [q6,   00.00 ,  56.25,     0.0 ]]



[HH,H06]=DHH(tabdh,0)



print "ARM=",ARM
print "ELBOW=",ELBOW
print "WRIST=",WRIST
print "FLIP=",FLIP


print "q1=",q1
print "q2=",q2
print "q3=",q3
print "q4=",q4
print "q5=",q5
print "q6=",q6
 

print "H06="; prm(H06)
print "Ht="; prm(Ht)
print "R36="; prm(R36)


%	Gera tabela para microcontrolador
%
%
clc


bits=10	       	  % Numero de bits do conversor
ADCmax=2^bits     % Valor maximo do ADC
Vref2=2.5	  % Tensão de referência em mv	 
Vref1=0.0
ADCresol=(Vref2-Vref1)/ADCmax % mVolts/bit


AMP=46.0          % Ganho do amplificador de instrumentação
vmax=54.0*1e-3	  % Tensao maxima em V  do termopar

Vmax=AMP*vmax     % Tensão maxima amplificada

input("Continuar")

adc=0:1:(ADCmax-1) ;

V=(Vref2-Vref1)/ADCmax*adc ;  % (Tensão medida no mcu)
v=V/AMP			   ;  %  Tensão medida no termopar

adc=adc(v<vmax) ;
V=V(v<vmax);
v=v(v<vmax);


v=v*1000.0 ;
N=size(v)(2)


for i=1:N;
   %T=[T,Ktemp(v(1,i))] ;
   T(i)=Ktemp(v(i));
end


%---------------------------------%
%  Calculo do tamanho da tabela   %
%---------------------------------%
disp "Tamanho da tabela =",N*2," bytes"


%---------------------------------%
%   Temperatura em ponto fixo     %
%   Qx.y
%---------------------------------%
N
RES=0.1  	 	% Resolução
MAX=max(T)      	% Valor maximo da temperatura
x=log(MAX)/log(2)       % Numero de bits da parte inteira
x=round(x)
y=-log(RES)/log(2)      % Numero de bits da parte fracionaria
y=round(y)
Nbits=x+y               % Numero de bits total
scale=2^y

Tfixed=round(T*scale);		% Converte a temperatura para ponto fixo

erromax=max(T-Tfixed/scale)

%-------------------------------------------%
%  Salva tabel construida para arquivo
%

fid=fopen("lookuptable.txt","w")
fprintf(fid,"Tabela de pesquisa para termopar tipo K\n")
fprintf(fid,"Table input: adc value\n")
fprintf(fid,"Table output: Temperature\n\n\n")

fprintf(fid,"//Tabela de pesquisa para termopar tipo K\n")
fprintf(fid,"//A temperatura esta em ponto fixo Q%i.%i\n",x,y)
fprintf(fid,"//ADC de %i bits  Vref2=%f  Vref1=%f",bits,Vref2,Vref1)
fprintf(fid,"//Ganho do amplificador G=%i\n",AMP)
fprintf(fid,"//Temperaturas\n")
fprintf(fid,"//RANGE %f a %f\n",min(T),max(T));
fprintf(fid,"//\n")
fprintf(fid,"//Uso:   T=Ktemp[valor_adc]/TABLESCALE, adc<=MAXINPUT\n")


fprintf(fid,"#define MAXINPUT   %i\n",N)
fprintf(fid,"#define TABLESCALE %i\n",scale)

fprintf(fid,"u16 Ktemp[MAXINPUT]={",N)
fprintf(fid,"%i",Tfixed(1))
for i=2:N
fprintf(fid,",%i",Tfixed(i))
end
fprintf(fid,"};\n")
fclose(fid)








#  	           MAKEFILE                            #
#------------------------------------------------------#
#  Makefile to compile C18 code in UNIX environment    #
#                                                      #
#  Author: Caio Rodrigues             		       #
#                                                      #
#  Usage: make       - Build Coff file                 #
#  	  make hex   - Build hex file                  #
#  	  make burn  - Burn in pickit2                 #
#                                                      #
#------------------------------------------------------#


# mcc18 instalation directory  : You must create a link to .wine/drive_c  by
# ln -s ~/.wine/drive_c  drivec

#------------------------------#
#             PATHS	       #
#------------------------------# 

#  microchip C18 installation directory
MCCPATH= $(HOME)/drivec/MCC18/bin
#INCP1 = /home/caio/cdc2/fastPICUSB_CDC/Cdc
INCP1 = $(shell pwd)

#------------------------------#
#           TOOL CHAIN         #
#------------------------------#
CC= wine $(MCCPATH)/mcc18.exe
LD = wine $(MCCPATH)/mplink.exe
AR = wine $(MCCPATH)/mplib.exe
MP2HEX= wine $(MCCPATH)/mp2hex.exe

#------------------------------#
#         SETTINGS	       #
#------------------------------# 
CFLAGS =  -p=18f4550 -Ou- -Ot- -Ob- -Op- -Or- -Od- -Opa-

INCLUDES =  -I"C:\mcc18\h" -I"C:\MCHPFSUSB\fw\CDC"

SRC=  $(shell find ./ -name "*.c") 		#  Find  all sources
SRCC= $(shell echo $(SRC) | sed 's/\.\///g')    # cuts the ./  from SRC 

COMMAND= $(CC) $(CFLAGS) /i$(INCP1) $(INCLUDES)


#------------------------------#
#   COMMANDS AND BUILDING      #
#------------------------------#  

MCHPUSB.cof:
	$(foreach SRCC,$(SRCC),  $(COMMAND)  $(SRCC)  ;) 
	$(LD) /l"c:\mcc18\lib"   /k$(INCP1) "rm18f4550.lkr" "main.o" "usbmmap.o" "usbdrv.o" "usb9.o" "usbdsc.o" "usbctrltrf.o" "user.o" "cdc.o" "temperature.o" "Startup.o" /z__MPLAB_BUILD=1 /m"MCHPUSB.map" /o"MCHPUSB.cof"
#	wine "C:\MCC18\bin\mplink.exe" /l"c:\mcc18\lib"   /k"C:\users\caio\My Documents\cdc2\fastPICUSB_CDC\Cdc" /k"C:\MCHPFSUSB\fw\CDC" "rm18f4550.lkr" "main.o" "usbmmap.o" "usbdrv.o" "usb9.o" "usbdsc.o" "usbctrltrf.o" "user.o" "cdc.o" "temperature.o" "Startup.o" /z__MPLAB_BUILD=1 /m"MCHPUSB.map" /o"MCHPUSB.cof"

hex:
	$(MP2HEX) $(INCP1)/MCHPUSB.cof 


clean:
	rm *.cod *.hex *.lst *.map *.out *.o *.cof

burn:   
	pk2cmdd MCHPUSB.hex

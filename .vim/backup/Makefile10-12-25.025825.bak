# 
# Makefile for sdcc
# 
# Compiler : sdcc
#
#	Author: Caio Rodrigues Soares Silva
#
#	Este Makefife gera compila arquivos fontes com o SDCC: Small Device Compiler, 
# um compilador C oper-source para Microcontroladores ,em especial para microcontroladores 
# da familia PIC, mas pode servir a outras arquiteturas.
#
#===================================================
# USO:
#
#  No diretório do projeto deve haver
#
# /path/projeto{
#             { main.c
#             { Makefile
#             { dists (diretório dos snapshots)
#
#====================================================
#  Comandos:
#
# $make 			: Compila o arquivo
# $make clean		: Limpa os arquivos gerados na compilação
# $make dists		: Cria snapshot do projeto, empacota os arquivos do projeto
# 				  	e põe no diretório /path/projeto/dists o arquivo 
# 				  	nome-projeto-(data-hor).tar.gz útil para criar versões
# 				  	diferentes do projeto e criar distribuições diferentes.
#
# $make cleandists 	: Limpa todos arquivos *.tar.gz em /path/projeto/dists
#---------------------------------------------------
#	Nome do código hex a ser quimado no MCU
#firmware do pic será firmware.hex 
#
PRJ		= firmware
#
#-------------------------------------------------
#	Código fonte
#
SRCC= main
SRC = $(SRCC).c
#
#---------------------------------------------
#	Diretório onde estão os arquivos fontes 
#
#PACKAGEDIR	= pr1
#
#---------------------------------------------------
#	Tipo de CPU usada
CPU		= -p16f877a
CPU2	= pic16f877a 	# Tipo da CPU para o desassembly GPASM
#
#--------------------------------------------------
#	Arquitetura , core 14 bits ou core 16 bits
#
ARCH	= -mpic14
#
#-------------------------------------------------------
#		Definições das ferramentas usadas para compilar
#
SDCC	= $(HOME)/usr/bin/sdcc	#Usa o SDCC instalado no diretório do usuario
CC		= $(SDCC)
GPASM 	= gpasm
GPDASM	= gpdasm
GPLINK	= gplink
#
#---------------------------------------------------------
# Flags do SDCC compilaçao
#
#  -c :compile only
#  -S :stop after assembly
#  -V : show actual command line the compiler executing
#  --verbose: Shows the various actions the compiler is performing
##
SDCCFLAGS	= --dumpall --debug -V --verbose --use-stdout  $(ARCH) $(CPU)
#
#--------------------------------------------------
#	Data atual do sistema
#
DATETIME  = $(shell date +%Y_%m_%d_%H%M%S)
#
#
#--------------------------------------------------------
# 		Alvo principal/Main Target
#
#all: $(PRJ).hex
#
#--------------------------------------------------------
#		Compilar todos códigos fontes
#
$(PRJ).hex: $(SRC)
	$(CC) $(SDCCFLAGS) $(SRC)
	@mv $(SRCC).hex $(PRJ).hex 
	@echo ""
	@echo "***** Compilação terminada ********"
#
#
#-------------------------------------------------------
#		Fazer snapshot do projeto
#
dist:
	@tar --exclude=*.tar.gz --exclude=./dists  --ignore-failed-read -zcvf \
		./dists/$(PRJ)-$(DATETIME).tar.gz ./$(PAKAGEDIR); 
	@echo "**** Snapshot Criado: $(PRJ)-$(DATETIME).tar.bz2 ******"


#-----------------------------------------------------
#
#
clean:
	rm *.asm *.hex *.lst *.cod *.o *.p *.adb  *.dump*
#
#------------------------------------------------------
#		
#
cleandist:
	rm -rf ./dists/*.tar.gz
#
#
#------------------------------------------------------
#			BURN firmware /'Queimar' firmware no MCU
#
#	Grava firmware (arquivo hex) no mcu
#
#	Por default o gravador aqui é o Pic Kit2
# e o firmware é gravado usando-se o PK2CMD
# este comando é similar ao make install
#
burn :
	sudo /bin/pk2cmd -PPIC16F877A -M -F/`pwd`/$(PRJ).hex
#
#
#
#--------------------------------------------------------
#		Desassemble o código asm gerado para verificação
#
disassembly :
	gpdasm -p $(CPU2) $(PRJ).hex | more

#
#######################################################
#END OF MAKEFILE
#######################################################
